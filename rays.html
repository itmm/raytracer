<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<title>Rays and Spheres</title>
<link rel="stylesheet" type="text/css" href="slides/slides.css"></head>
<body>
<h1>Rays and Spheres</h1>
<div class="slides">
<div>
<div>
<h1>Rays and Spheres</h1>
</div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">types</span>)</span><br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Ray</span> {<br/>
<span class="in2"></span><span class="type">Tuple</span> <span class="var">origin</span>;<br/>
<span class="in2"></span><span class="type">Tuple</span> <span class="var">direction</span>;<br/>
<span class="in2"></span><span class="macro">@put(<span class="name">methods</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">types</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">4</span>, <span class="num">5</span>, <span class="num">6</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="var">origin</span> == <span class="var">o</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="var">direction</span> == <span class="var">d</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">methods</span>)</span><br/>
<span class="in1"></span><span class="var">constexpr</span> <span class="type">auto</span> <span class="fn">pos</span>(<span class="var">float</span> <span class="var">t</span>) <span class="type">const</span>;<br/>
<span class="macro">@end(<span class="name">methods</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="var">constexpr</span> <span class="type">auto</span> <span class="type">Ray</span>::<span class="fn">pos</span>(<span class="var">float</span> <span class="var">t</span>) <span class="type">const</span> {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">origin</span> + <span class="var">t</span> * <span class="var">direction</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">1</span>, <span class="num">0</span>, <span class="num">0</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="fn">pos</span>(<span class="num">0</span>) == <span class="var">o</span>);<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">e1</span> { <span class="fn">mk_point</span>(<span class="num">3</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="fn">pos</span>(<span class="num">1</span>) == <span class="var">e1</span>);<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">e2</span> { <span class="fn">mk_point</span>(<span class="num">1</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="fn">pos</span>(-<span class="num">1</span>) == <span class="var">e2</span>);<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">e3</span> { <span class="fn">mk_point</span>(<span class="num">4</span>.<span class="num">5</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r</span>.<span class="fn">pos</span>(<span class="num">2</span>.<span class="num">5</span>) == <span class="var">e3</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">types</span>)</span><br/>
<span class="in1"></span><span class="macro">@Put(<span class="name">needed by object</span>)</span>;<br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Object</span> {<br/>
<span class="in2"></span><span class="type">Matrix</span> <span class="var">transform</span> = <span class="var">identity</span>;<br/>
<span class="in2"></span><span class="type">Matrix</span> <span class="var">inv_transform</span> = <span class="var">identity</span>;<br/>
<span class="in2"></span><span class="macro">@Put(<span class="name">object attribs</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Sphere</span>: <span class="type">Object</span> {<br/>
<span class="in2"></span><span class="macro">@Put(<span class="name">sphere attribs</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">types</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="type">vector</span>&gt;<br/>
<span class="macro">@End(<span class="name">includes</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">needed by object</span>)</span><br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Object</span>;<br/>
<span class="in1"></span><span class="type">struct</span> <span class="type">Intersection</span> {<br/>
<span class="in2"></span><span class="var">float</span> <span class="var">t</span>;<br/>
<span class="in2"></span><span class="type">Object</span> *<span class="var">object</span>;<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">needed by object</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">needed by object</span>)</span><br/>
<span class="in1"></span><span class="keyword">class</span> <span class="type">Intersections</span>:<br/>
<span class="in2"></span><span class="keyword">public</span> <span class="type">std</span>::<span class="type">vector</span>&lt;<span class="type">Intersection</span>&gt;<br/>
<span class="in1"></span>{<br/>
<span class="in2"></span><span class="keyword">public</span>:<br/>
<span class="in3"></span><span class="macro">@put(<span class="name">xs methods</span>)</span>;<br/>
<span class="in1"></span>};<br/>
<span class="macro">@End(<span class="name">needed by object</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@def(<span class="name">xs methods</span>)</span><br/>
<span class="in1"></span><span class="fn">Intersections</span>(<span class="type">std</span>::<span class="var">initializer_list</span>&lt;<span class="type">Intersection</span>&gt; <span class="var">l</span>);<br/>
<span class="macro">@end(<span class="name">xs methods</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="var">inline</span> <span class="type">bool</span> <span class="var">operator</span>&lt;(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Intersection</span> &amp;<span class="var">a</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Intersection</span> &amp;<span class="var">b</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">a</span>.<span class="var">t</span> &lt; <span class="var">b</span>.<span class="var">t</span>;<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">algorithm</span>&gt;<br/>
<span class="macro">@End(<span class="name">includes</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="type">Intersections</span>::<span class="fn">Intersections</span>(<span class="type">std</span>::<span class="var">initializer_list</span>&lt;<span class="type">Intersection</span>&gt; <span class="var">l</span>): <span class="type">std</span>::<span class="type">vector</span>&lt;<span class="type">Intersection</span>&gt;(<span class="var">l</span>) {<br/>
<span class="in2"></span><span class="type">std</span>::<span class="fn">sort</span>(<span class="fn">begin</span>(), <span class="fn">end</span>());<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">object attribs</span>)</span><br/>
<span class="in1"></span><span class="var">virtual</span> <span class="type">Intersections</span> <span class="fn">intersect</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Ray</span> &amp;<span class="var">r</span><br/>
<span class="in1"></span>) = <span class="num">0</span>;<br/>
<span class="macro">@End(<span class="name">object attribs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Def(<span class="name">sphere attribs</span>)</span><br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="fn">intersect</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Ray</span> &amp;<span class="var">r</span><br/>
<span class="in1"></span>) <span class="var">override</span>;<br/>
<span class="macro">@End(<span class="name">sphere attribs</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="var">inline</span> <span class="var">constexpr</span> <span class="type">Ray</span> <span class="fn">transform</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Ray</span> &amp;<span class="var">r</span>, <span class="type">const</span> <span class="type">Matrix</span> &amp;<span class="var">m</span><br/>
<span class="in1"></span>);<br/>
<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="type">Sphere</span>::<span class="fn">intersect</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Ray</span> &amp;<span class="var">r</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">r2</span> { ::<span class="fn">transform</span>(<span class="var">r</span>, <span class="var">inv_transform</span>) };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">s2r</span> { <span class="var">r2</span>.<span class="var">origin</span> - <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">0</span>) };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">a</span> { <span class="fn">dot</span>(<span class="var">r2</span>.<span class="var">direction</span>, <span class="var">r2</span>.<span class="var">direction</span>) };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">b</span> { <span class="num">2</span> * <span class="fn">dot</span>(<span class="var">r2</span>.<span class="var">direction</span>, <span class="var">s2r</span>) };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">c</span> { <span class="fn">dot</span>(<span class="var">s2r</span>, <span class="var">s2r</span>) - <span class="num">1</span> };<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">discr</span> { <span class="var">b</span> * <span class="var">b</span> - <span class="num">4</span> * <span class="var">a</span> * <span class="var">c</span> };<br/>
<span class="in2"></span><span class="keyword">if</span> (<span class="var">discr</span> &lt; <span class="num">0</span>) { <br/>
<span class="in3"></span><span class="keyword">return</span> {};<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="type">auto</span> <span class="var">sd</span> { <span class="fn">sqrtf</span>(<span class="var">discr</span>) };<br/>
<span class="in2"></span><span class="keyword">return</span> {<br/>
<span class="in3"></span>{(-<span class="var">b</span> - <span class="var">sd</span>)/(<span class="num">2</span> * <span class="var">a</span>), <span class="var">this</span>},<br/>
<span class="in3"></span>{(-<span class="var">b</span> + <span class="var">sd</span>)/(<span class="num">2</span> * <span class="var">a</span>), <span class="var">this</span>}<br/>
<span class="in2"></span>};<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, <span class="num">4</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, <span class="num">6</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">1</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, <span class="num">5</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, <span class="num">5</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">2</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">0</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">0</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, -<span class="num">1</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, <span class="num">1</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, -<span class="num">6</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, -<span class="num">4</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i1</span> { <span class="num">1</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i2</span> { <span class="num">2</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="var">xs</span> { <span class="var">i1</span>, <span class="var">i2</span> };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, <span class="num">1</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, <span class="num">2</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">object</span> == &amp;<span class="var">s</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">object</span> == &amp;<span class="var">s</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="fn">hit</span>(<span class="type">Intersections</span> &amp;<span class="var">xs</span>) {<br/>
<span class="in2"></span><span class="keyword">for</span> (<span class="type">auto</span> <span class="var">i</span> = <span class="var">xs</span>.<span class="fn">begin</span>(); <span class="var">i</span> != <span class="var">xs</span>.<span class="fn">end</span>(); ++<span class="var">i</span>) {<br/>
<span class="in3"></span><span class="keyword">if</span> (<span class="var">i</span>-&gt;<span class="var">t</span> &gt;= <span class="num">0</span>) { <span class="keyword">return</span> <span class="var">i</span>; }<br/>
<span class="in2"></span>}<br/>
<span class="in2"></span><span class="keyword">return</span> <span class="var">xs</span>.<span class="fn">end</span>();<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="var">inline</span> <span class="var">constexpr</span> <span class="type">bool</span> <span class="var">operator</span>==(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Intersection</span> &amp;<span class="var">a</span>,<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Intersection</span> &amp;<span class="var">b</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span><br/>
<span class="in3"></span><span class="var">a</span>.<span class="var">object</span> == <span class="var">b</span>.<span class="var">object</span> &amp;&amp;<br/>
<span class="in4"></span><span class="fn">eq</span>(<span class="var">a</span>.<span class="var">t</span>, <span class="var">b</span>.<span class="var">t</span>);<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i1</span> { <span class="num">1</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i2</span> { <span class="num">2</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="var">xs</span> { <span class="var">i2</span>, <span class="var">i1</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">i</span> { <span class="fn">hit</span>(<span class="var">xs</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(*<span class="var">i</span> == <span class="var">i1</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i1</span> { -<span class="num">1</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i2</span> { <span class="num">1</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="var">xs</span> { <span class="var">i2</span>, <span class="var">i1</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">i</span> { <span class="fn">hit</span>(<span class="var">xs</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(*<span class="var">i</span> == <span class="var">i2</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i1</span> { -<span class="num">2</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i2</span> { -<span class="num">1</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="var">xs</span> { <span class="var">i2</span>, <span class="var">i1</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">i</span> { <span class="fn">hit</span>(<span class="var">xs</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">i</span> == <span class="var">xs</span>.<span class="fn">end</span>());<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i1</span> { <span class="num">5</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i2</span> { <span class="num">7</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i3</span> { -<span class="num">3</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersection</span> <span class="var">i4</span> { <span class="num">2</span>, &amp;<span class="var">s</span> };<br/>
<span class="in1"></span><span class="type">Intersections</span> <span class="var">xs</span> { <span class="var">i1</span>, <span class="var">i2</span>, <span class="var">i3</span>, <span class="var">i4</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">i</span> { <span class="fn">hit</span>(<span class="var">xs</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(*<span class="var">i</span> == <span class="var">i4</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">functions</span>)</span><br/>
<span class="in1"></span><span class="var">inline</span> <span class="var">constexpr</span> <span class="type">Ray</span> <span class="fn">transform</span>(<br/>
<span class="in2"></span><span class="type">const</span> <span class="type">Ray</span> &amp;<span class="var">r</span>, <span class="type">const</span> <span class="type">Matrix</span> &amp;<span class="var">m</span><br/>
<span class="in1"></span>) {<br/>
<span class="in2"></span><span class="keyword">return</span> {<br/>
<span class="in3"></span><span class="var">m</span> * <span class="var">r</span>.<span class="var">origin</span>,<br/>
<span class="in3"></span><span class="var">m</span> * <span class="var">r</span>.<span class="var">direction</span><br/>
<span class="in2"></span>};<br/>
<span class="in1"></span>}<br/>
<span class="macro">@End(<span class="name">functions</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">1</span>, <span class="num">0</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">m</span> { <span class="fn">translation</span>(<span class="num">3</span>, <span class="num">4</span>, <span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">r2</span> { <span class="fn">transform</span>(<span class="var">r</span>, <span class="var">m</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">eo</span> { <span class="fn">mk_point</span>(<span class="num">4</span>, <span class="num">6</span>, <span class="num">8</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r2</span>.<span class="var">origin</span> == <span class="var">eo</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r2</span>.<span class="var">direction</span> == <span class="var">d</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">1</span>, <span class="num">2</span>, <span class="num">3</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">1</span>, <span class="num">0</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">m</span> { <span class="fn">scaling</span>(<span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">r2</span> { <span class="fn">transform</span>(<span class="var">r</span>, <span class="var">m</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">eo</span> { <span class="fn">mk_point</span>(<span class="num">2</span>, <span class="num">6</span>, <span class="num">12</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">ed</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">3</span>, <span class="num">0</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r2</span>.<span class="var">origin</span> == <span class="var">eo</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">r2</span>.<span class="var">direction</span> == <span class="var">ed</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">s</span>.<span class="var">transform</span> == <span class="var">identity</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">m</span> { <span class="fn">translation</span>(<span class="num">2</span>, <span class="num">3</span>, <span class="num">4</span>) };<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">transform</span> = <span class="var">m</span>;<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">inv_transform</span> = <span class="fn">inv</span>(<span class="var">m</span>);<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">s</span>.<span class="var">transform</span> == <span class="var">m</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">transform</span> = <span class="fn">scaling</span>(<span class="num">2</span>, <span class="num">2</span>, <span class="num">2</span>);<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">inv_transform</span> = <span class="fn">inv</span>(<span class="var">s</span>.<span class="var">transform</span>);<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">2</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">0</span>].<span class="var">t</span>, <span class="num">3</span>);<br/>
<span class="in1"></span><span class="fn">assert_eq</span>(<span class="var">xs</span>[<span class="num">1</span>].<span class="var">t</span>, <span class="num">7</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">unit-tests</span>)</span> {<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">o</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">d</span> { <span class="fn">mk_vector</span>(<span class="num">0</span>, <span class="num">0</span>, <span class="num">1</span>) };<br/>
<span class="in1"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">o</span>, <span class="var">d</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">s</span>;<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">transform</span> = <span class="fn">translation</span>(<span class="num">5</span>, <span class="num">0</span>, <span class="num">0</span>);<br/>
<span class="in1"></span><span class="var">s</span>.<span class="var">inv_transform</span> = <span class="fn">inv</span>(<span class="var">s</span>.<span class="var">transform</span>);<br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">s</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in1"></span><span class="fn">assert</span>(<span class="var">xs</span>.<span class="fn">size</span>() == <span class="num">0</span>);<br/>
} <span class="macro">@End(<span class="name">unit-tests</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">includes</span>)</span><br/>
<span class="in1"></span><span class="keyword">#include</span> &lt;<span class="var">fstream</span>&gt;<br/>
<span class="macro">@End(<span class="name">includes</span>)</span><br/>
</code></div>
</div>
<div><div>
<code>
<span class="macro">@Add(<span class="name">main</span>)</span><br/>
<span class="in1"></span><span class="keyword">#if</span> <span class="num">0</span><br/>
<span class="in1"></span><span class="type">auto</span> <span class="var">ray_origin</span> { <span class="fn">mk_point</span>(<span class="num">0</span>, <span class="num">0</span>, -<span class="num">5</span>) };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">wall_z</span> { <span class="num">10</span> };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">wall_size</span> { <span class="num">7</span> };<br/>
<span class="in1"></span><span class="type">int</span> <span class="var">canvas_pixels</span> { <span class="num">100</span> };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">pixel_size</span> { <span class="var">wall_size</span> / <span class="var">canvas_pixels</span> };<br/>
<span class="in1"></span><span class="var">float</span> <span class="var">half</span> { <span class="var">wall_size</span> / <span class="num">2</span> };<br/>
<span class="in1"></span><span class="type">Color</span> <span class="var">red</span> { <span class="num">1</span>, <span class="num">0</span>, <span class="num">0</span> };<br/>
<span class="in1"></span><span class="type">Color</span> <span class="var">black</span> { <span class="num">0</span>, <span class="num">0</span>, <span class="num">0</span> };<br/>
<span class="in1"></span><span class="type">Sphere</span> <span class="var">shape</span>;<br/>
<span class="in1"></span><span class="type">std</span>::<span class="type">ofstream</span> <span class="fn">o</span>(<span class="str">"ball.ppm"</span>);<br/>
<span class="in1"></span><span class="fn">mk_ppm</span>(<span class="var">o</span>, <span class="var">canvas_pixels</span>, <span class="var">canvas_pixels</span>,<br/>
<span class="in2"></span>[&amp;](<span class="type">int</span> <span class="var">x</span>, <span class="type">int</span> <span class="var">y</span>) {<br/>
<span class="in3"></span><span class="var">float</span> <span class="var">world_y</span> { <span class="var">half</span> - <span class="var">pixel_size</span> * <span class="var">y</span> };<br/>
<span class="in3"></span><span class="var">float</span> <span class="var">world_x</span> { -<span class="var">half</span> + <span class="var">pixel_size</span> * <span class="var">x</span> };<br/>
<span class="in3"></span><span class="type">auto</span> <span class="var">pos</span> { <span class="fn">mk_point</span>(<span class="var">world_x</span>, <span class="var">world_y</span>, <span class="var">wall_z</span>) };<br/>
<span class="in3"></span><span class="type">Ray</span> <span class="var">r</span> { <span class="var">ray_origin</span>, <span class="fn">norm</span>(<span class="var">pos</span> - <span class="var">ray_origin</span>) };<br/>
<span class="in3"></span><span class="type">auto</span> <span class="var">xs</span> { <span class="var">shape</span>.<span class="fn">intersect</span>(<span class="var">r</span>) };<br/>
<span class="in3"></span><span class="keyword">return</span> <span class="fn">hit</span>(<span class="var">xs</span>) == <span class="var">xs</span>.<span class="fn">end</span>() ? <span class="var">black</span> : <span class="var">red</span>;<br/>
<span class="in2"></span>}<br/>
<span class="in1"></span>);<br/>
<span class="in1"></span><span class="keyword">#endif</span><br/>
<span class="macro">@End(<span class="name">main</span>)</span><br/>
</code></div>
</div>
</body>
</html>
